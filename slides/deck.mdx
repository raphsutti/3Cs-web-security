export { default as theme } from "./src";
import { Head, Image } from "mdx-deck";
import {
  Frontpage,
  Lastpage,
  Layout,
  LayoutNoFooter,
  Split,
  BGImage,
} from "./src";
import { CodeSurfer } from "mdx-deck-code-surfer";
import nightOwl from "prism-react-renderer/themes/nightOwl";

<Head>
  <title>Web security 101: Cookies, CSRF, CORS, and XSS</title>
</Head>

<BGImage src={require("file-loader!./images/sesamestreet2.jpg")} />

<Frontpage>

# Today's letter is C

## Cookies, CSRF, CORS, and XSS

### Web security 101

</Frontpage>

---

export default Layout;

### My name is Raph

---

export default Split;

<img src={require("file-loader!./images/codeclub.jpg")} />

- ~~Mechanical Engineer~~
- ~~GRC Security~~
- Developer @ SEEK
- Really like learning
- Really like teaching

---

export default Layout;

### Cookie

### XSS

### CSRF

### CORS

---

export default Layout;

What is a cookie?

---

export default Layout;

Have you ever wonder?

<img src={require("file-loader!./images/elmothink.gif")} />

```notes
While doing online shopping,
you add things to cart,
you go get a coffee and come back and the application remembers you?
```

---

export default Layout;

<img src={require("file-loader!./images/buthow.jpg")} />

---

export default Layout;

Back in the old days

<img src={require("file-loader!./images/grandpa.gif")} />

```notes
Things were much simpler
```

---

export default Layout;

Simpler times

- Simple static web pages
- No username/passwords
- No need to keep track of who you are
- No big impact of getting hacked

```notes
Risk of website defacement
```

---

export default Layout;

Now

- Complex web applications
- We need to keep track of logged on users
- Hide all the secrets
- Stop all the unauthorised users

---

export default Layout;

<img src={require("file-loader!./images/oprahcookie.jpg")} />

```notes
We keep track of sessions with cookies!
```

---

export default Layout;

<img src={require("file-loader!./images/cookie1.png")} />

---

export default Layout;

<img src={require("file-loader!./images/cookie2.png")} />

---

export default Layout;

<img src={require("file-loader!./images/cookie3.png")} />

---

export default Layout;

<img src={require("file-loader!./images/cookie4.png")} />

```notes
Cookie is given so users dont need to log in every times
Cookie is a key-value pair supplied in the HTTP header
Cookie value format is up to the programmer
```

---

export default Layout;

<img src={require("file-loader!./images/momentslater.jpg")} />

---

export default Layout;

<img src={require("file-loader!./images/cookie5.png")} />

```notes
Browser automatically supplies the cookie
```

---

export default Layout;

<img src={require("file-loader!./images/cookie6.png")} />

---

export default Layout;

<img src={require("file-loader!./images/demogods.png")} />

Attack: Bad cookie value

http://vuln.hacker.com:2021/

```notes
1.1-cookie.ts
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu1.jpg")} />

```notes
Dont worry pikachu we have fix
```

---

export default Layout;

<img src={require("file-loader!./images/demogods.png")} />

Defence: Better cookie value

http://vuln.hacker.com:2021/

```notes
1.1.r1-cookie-random.ts
```

---

export default Layout;

What is Cross Site Scripting (XSS)?

---

export default Layout;

Web application uses untrusted user input without validation or encoding

- `<` can be encoded to `&lt;`
- Without encoding, browser run `<script>` as scripts
- With encoding, browser _show_ `&lt;script&gt;`

```notes
Type of injection, where malicious scripts are injected into trusted websites.
XSS attacks occur when an attacker uses a web application to send malicious code,
generally in the form of a browser side script
Flaws occur anywhere a web application uses input from a user within the output it generates without validating or encoding it.
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Attack: XSS to exfil cookies

http://vuln.hacker.com:2021/

```notes
1.2-cookie-exfil.ts

Get target to open malicious link
Cookie stolen
No need for password. Password complexity out the window
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu2.jpg")} />

---

export default Layout;

<img src={require("file-loader!./images/lupin.gif")} />

A few defense techniques

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Sanitise user input

http://vuln.hacker.com:2021/

```notes
1.2.r1-xss-sanitise.ts

XSS no longer work
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
router.get("/", (ctx) => {
  const param = ctx.query.v // I trust you, user input ðŸ”¥
  ...
  ctx.body = \`<h3>
    Oh cool, I can repeat your query param: \${param}. Harmless right?</h3>\`
    })
`}
/>

```notes
current code
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
router.get("/", (ctx) => {
  const param = escape(ctx.query.v) // sanitised âœ¨
  ...
  ctx.body = \`<h3>
    Oh cool, I can repeat your query param: \${param}. Harmless right?</h3>\`
    })
`}
/>

```notes
Sanitised code
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Strong cookies - httpOnly

http://vuln.hacker.com:2021/

```notes
1.2.r2-cookie-httpOnly.ts

Cookie no longer accessible via javascript
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId);
`}
/>

```notes
current code
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: true,
});
`}
/>

```notes
httpOnly - cookie accesible via javascript

Great, so which method should we use?

Input sanitisation or httpOnly cookie header?
```

---

export default Layout;

<img src={require("file-loader!./images/whynotboth.gif")} />

---

export default Layout;

There are other great cookie headers too!

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: true,
  secure: true,
  sameSite: "lax",
  path: "/",
});
`}
/>

```notes
httpOnly - cookie accesible via javascript
secure - HTTPS
sameSite - TODO cookies sent over same site (strict or lax)
path - TODO
```

---

export default Layout;

What is Cross Site Request Forgery (CSRF)?

---

export default Layout;

Causes user to execute unwanted actions where they are currently authenticated.

- Eg. Transferring funds, changing their email address

- If user is admin, CSRF can compromise the entire application

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Our web app has a new fund transfer feature!

http://vuln.hacker.com:2021/

```notes
2.1-csrf.ts
```

---

export default Layout;

How does that work?

---

export default Layout;

<img src={require("file-loader!./images/transfer1.png")} />

```notes
Again, browser automatically submits cookie
```

---

export default Layout;

<img src={require("file-loader!./images/transfer2.png")} />

```notes
Browser then validates and perform transfer action
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Attack: CSRF - causing a fund transfer

http://vuln.hacker.com:2021/

http://127.0.0.1:9000/malicious.html

```notes
2.1-csrf.ts
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu3.jpg")} />

---

export default Layout;

Wait what happened?

---

export default Layout;

<img src={require("file-loader!./images/csrf1.png")} />

```notes
This time we have an attacker on the left asking you to visit their site with your browser
```

---

export default Layout;

<img src={require("file-loader!./images/csrf2.png")} />

```notes
You visit the site and was redirected to do a POST to the app and transfer funds to bob
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="html"
  code={`
<form method='POST' action='http://vuln.hacker.com:2021/transfer'
  style='display: none'>
  <input name='amount' value='50' />
  <input name='to' value='bob' />
  <input type='submit' value='Send' />
</form>
<script>
  document.forms[0].submit()
</script>
`}
/>

```notes
This code is embedded in the attackers iframe site
Note display: none and forms[0].submit() (auto submit)
```

---

export default Layout;

<img src={require("file-loader!./images/defence.gif")} />

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Strong cookies - sameSite

http://vuln.hacker.com:2021/

```notes
2.1.r1-csrf-samesite-cookie.ts

Cookie no longer accessible via another domain
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  sameSite: "lax",
});
`}
/>

```notes
httpOnly - cookie accesible via javascript
secure - HTTPS
sameSite - cookie sending depending on sites
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: anti-CSRF token

http://vuln.hacker.com:2021/

```notes
2.1.r2-csrf-token.ts

Cannot perform a transfer without a generated token on forms
```

---

export default Layout;

What is Cross-Origin Resource Sharing (CORS)

---

export default Layout;

- Relaxation of the same origin policy
- Allow any other origins (domain, scheme, or port) to load resources
- Doesn't protect from CSRF but could actually introduce vulns

---

export default Layout;

ACAO header

Credentials true header

---

export default Layout;

What happens with misconfigured CORS?

- Auto reflecting ACAO header
- origin: null

---

export default Layout;

- Obtain sensitive info eg API keys displayed after logging in

---

export default Layout;

- ACAO: "\*"
- credentials: true

---

export default Layout;

Confusing origin: null

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu4.jpg")} />

---

export default Layout;

# Goodies

#### CS253: https://web.stanford.edu/class/cs253/

#### PortSwigger Web Security Academy: https://portswigger.net/web-security

#### Exploiting CORS Misconfigurations - James Kettle: https://youtu.be/wgkj4ZgxI4c

```notes
We are just scratching the surface!

If you are interested to a more deep dive here are some videos and labs
```

---

export default LayoutNoFooter;

<Lastpage></Lastpage>

# Thank You

```notes
Thanks for listening!
```
