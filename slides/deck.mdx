export { default as theme } from "./src";
import { Head, Image } from "mdx-deck";
import {
  Frontpage,
  LargeEmoji,
  Lastpage,
  Layout,
  LayoutNoFooter,
  Split,
  BGImage,
} from "./src";
import { CodeSurfer } from "mdx-deck-code-surfer";
import nightOwl from "prism-react-renderer/themes/nightOwl";

<Head>
  <title>Web security 101: Cookies, CSRF, CORS, and XSS</title>
</Head>

<BGImage src={require("file-loader!./images/sesamestreet2.jpg")} />

<Frontpage>

# Today's letter is C

## Cookies, CSRF, CORS, and XSS

### Web security 101

</Frontpage>

```notes
X in XSS stands for Cross
```

---

export default Layout;

My name is Raph

---

export default Split;

<img src={require("file-loader!./images/codeclub.jpg")} />

- ~~Mechanical Engineer~~
- ~~GRC Security~~
- Developer @ SEEK
- Really like learning
- Really like teaching

---

export default Layout;

Disclaimer

```notes
I am a new at this
This is just scratching the surface
Hope you might learn something new today
```

---

export default Layout;

Cookie

XSS

CSRF

CORS

---

export default Layout;

What is a cookie?

```notes
No I'm talking about HTTP cookies
```

---

export default Layout;

Have you ever wonder?

<img src={require("file-loader!./images/elmothink.gif")} />

```notes
While doing online shopping,
you add things to cart,
you go get a coffee and come back and the application remembers you and the content of your cart?
```

---

export default Layout;

<img src={require("file-loader!./images/buthow.jpg")} />

```notes
Well lets go back to history
```

---

export default Layout;

Back in the old days

<img src={require("file-loader!./images/grandpa.gif")} />

```notes
Things were much simpler
```

---

export default Layout;

Simpler times

- Simple static web pages
- No username/passwords
- No need to keep track of who you are / states
- No big impact of getting hacked

```notes
The worst thing could be website defacement
```

---

export default Layout;

Now

- Complex web applications
- We need to keep track of logged on users
- Hide all the secrets
- Stop all the unauthorised users

```notes
So how do we keep track of users?
```

---

export default Layout;

<img src={require("file-loader!./images/oprahcookie.jpg")} />

```notes
We keep track of sessions with cookies!

So lets talk about how this works
```

---

export default Layout;

<img src={require("file-loader!./images/cookie1.jpg")} />

```notes
Browser on the left and server on the right
```

---

export default Layout;

<img src={require("file-loader!./images/cookie2.jpg")} />

```notes
Since the server has no knowledge of who you are,
you get a login page
```

---

export default Layout;

<img src={require("file-loader!./images/cookie3.jpg")} />

```notes
So you entered a predetermined secret password
```

---

export default Layout;

<img src={require("file-loader!./images/cookie4.jpg")} />

```notes
Server validates password then gives a cookie

Cookie is given so users dont need to log in every time

The header Set-Cookie is used

Cookie is a key-value pair supplied in the HTTP header
Cookie value format is up to the programmer

In this example is the key: SessionId and value: 1
```

---

export default Layout;

<img src={require("file-loader!./images/momentslater.jpg")} />

```notes
What if you close the browser and go get a coffee now?
```

---

export default Layout;

<img src={require("file-loader!./images/cookie5.jpg")} />

```notes
You come back and send a request to /
Browser automatically supplies the cookie

note the cookie header
```

---

export default Layout;

<img src={require("file-loader!./images/cookie6.jpg")} />

```notes
Browser supplies your account details as the cookie checks out
```

---

export default Layout;

<img src={require("file-loader!./images/demogods.png")} />

Attack: Bad cookie value

http://vuln.hacker.com:2021/

```notes
So lets see this in action and a bad implementation of cookie value

1.1-cookie.ts
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu1.jpg")} />

```notes
Dont worry pikachu we have fix
```

---

export default Layout;

<img src={require("file-loader!./images/demogods.png")} />

Defence: Better cookie value

http://vuln.hacker.com:2021/

```notes
Lets see the fix

1.1.r1-cookie-random.ts
```

---

export default Layout;

What is Cross Site Scripting (XSS)?

---

export default Layout;

Web application uses user input without validation or encoding

- Without encoding - `<script>`, browser run code inside
- `<` can be encoded to `&lt;`
- With encoding - `&lt;script&gt;`

```notes
Browser side scripts are injected into websites.

Occur any where a web application uses input from a user without validating or encoding it.

Example payload attacker might inject is in between script tags.
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Attack: XSS to exfil cookies

http://vuln.hacker.com:2021/

```notes
Lets see how we can use XSS to steal some cookies

As you have seen before, cookies can be used to get into a user session without logging in

1.2-cookie-exfil.ts

No need for password. Password complexity out the window
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu2.jpg")} />

---

export default Layout;

<img src={require("file-loader!./images/lupin.gif")} />

A few defense techniques

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Sanitise user input

http://vuln.hacker.com:2021/

```notes
1.2.r1-xss-sanitise.ts

XSS no longer work
View source will show &lt; encoding
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
router.get("/", (ctx) => {
  const param = ctx.query.v // I trust you, user input 🔥
  ...
  ctx.body = \`<h3>
    Oh cool, I can repeat your query param: \${param}. Harmless right?</h3>\`
    })
`}
/>

```notes
current code
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
router.get("/", (ctx) => {
  const param = escape(ctx.query.v) // sanitised ✨
  ...
  ctx.body = \`<h3>
    Oh cool, I can repeat your query param: \${param}. Harmless right?</h3>\`
    })
`}
/>

```notes
Sanitised code
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Strong cookies - httpOnly

http://vuln.hacker.com:2021/

```notes
1.2.r2-cookie-httpOnly.ts

Cookie no longer accessible via javascript
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: false,
});
`}
/>

```notes
current code
You might think, httpOnly means cookie will be sent over HTTP protocol only
rather than HTTPS?
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: true,
});
`}
/>

```notes
httpOnly - cookie accesible via javascript

Great, so which method should we use?

Input sanitisation or httpOnly cookie header?
```

---

export default Layout;

<img src={require("file-loader!./images/whynotboth.gif")} />

---

export default Layout;

There are other great cookie headers too!

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: true,
  secure: true,
  sameSite: "lax",
});
`}
/>

```notes
httpOnly - cookie accesible via javascript
secure - Sent only over the HTTPS protocol
sameSite - Whether/when cookies are sent with cross-site requests

What does sameSite mean?
```

---

export default Layout;

What is Cross Site Request Forgery (CSRF)?

---

export default Layout;

Cause user to execute unwanted actions while they are currently authenticated

- Eg. Transferring funds, changing email address

- If user is admin, CSRF can compromise the entire application

---

export default Layout;

<img src={require("file-loader!./images/goodnews.gif")} />

Our web app has a new fund transfer feature!

```notes
Lets have a look at how this works
```

---

export default Layout;

<img src={require("file-loader!./images/transfer1.jpg")} />

```notes
After logging in and receiving a cookie from the server
Browser automatically submits cookie with transfer POST

This time, we request a fund transfer
```

---

export default Layout;

<img src={require("file-loader!./images/transfer2.jpg")} />

```notes
Server then validates cookie and perform transfer action
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Attack: CSRF - unintended a fund transfer

http://vuln.hacker.com:2021/

http://127.0.0.1:9000/malicious.html

```notes
2.1-csrf.ts

Visiting malicious page cause uninteded fund transfer to bob
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu3.jpg")} />

---

export default Layout;

<img src={require("file-loader!./images/confused.gif")} />

Wait what happened?

---

export default Layout;

<img src={require("file-loader!./images/csrf1.jpg")} />

```notes
This time we have an attacker's server on the left asking you to visit their site with your browser
```

---

export default Layout;

<img src={require("file-loader!./images/csrf2.jpg")} />

```notes
You visit the site and was redirected to do a POST to the app and transfer funds to bob

The cookie was automatically submitted by the browser!

The attacker doesnt need to know your password or steal your cookies
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="html"
  code={`
<form method='POST' action='http://vuln.hacker.com:2021/transfer'
  style='display: none'>
  <input name='amount' value='50' />
  <input name='to' value='bob' />
  <input type='submit' value='Send' />
</form>
<script>
  document.forms[0].submit()
</script>
`}
/>

```notes
This code is embedded in the attackers iframe site
Note display: none and forms[0].submit() (auto submit)
```

---

export default Layout;

<img src={require("file-loader!./images/defence.gif")} />

```notes
Time for some defence
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: Strong cookies - sameSite

http://vuln.hacker.com:2021/

```notes
2.1.r1-csrf-samesite-cookie.ts

Cookie no longer accessible via another domain
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
ctx.cookies.set("sessionId", nextSessionId, {
  httpOnly: true,
  secure: true,
  sameSite: "lax",
});
`}
/>

```notes
httpOnly - cookie accesible via javascript
secure - HTTPS
sameSite - cookie sending depending on sites
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: anti-CSRF token

http://vuln.hacker.com:2021/

```notes
2.1.r2-csrf-token.ts

Cannot perform a transfer without a generated token on forms

See invalid cookie response
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="html"
  code={`
<form method='POST' action='/transfer'>
  Send amount:
  <input name='amount' />
  To user:
  <input name='to' />
  <input type='submit' value='Send' />
  <input type="hidden" name="anti" value=\${token} />
</form>
`}
/>

```notes
We add a hidden form field for a token to be submitted with this specific form loaded
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
if (token !== ctx.request.body.anti) {
    return (ctx.body = "Invalid cookie");
}
`}
/>

```notes
And we do a check if token matches what was given
```

---

export default Layout;

What is Cross-Origin Resource Sharing (CORS)

---

export default Layout;

<img src={require("file-loader!./images/cors-error.png")} />

- Cross origin requests normally blocked by browser
- CORS = Relaxation of the same origin policy
- Could introduce CSRF vulns

```notes
Those who worked with frontend server talking to backend server would run into this

The request normally blocked by the browser

Setting up CORS will let browsers get passed this error

origin: (domain, scheme, or port)
```

---

export default Layout;

How does it work? - HTTP Headers

- Access-Control-Allow-Origin
- Access-Control-Allow-Credentials

```notes
Important HTTP headers

ACAO
ACAC
```

---

export default Layout;

<img src={require("file-loader!./images/cors1.jpg")} />

```notes
Access malicious site that redirects to fetch sensitive data that is in the server on the right
```

---

export default Layout;

<img src={require("file-loader!./images/cors2.jpg")} />

```notes
Browser adds Origin header as it is a cross origin request
```

---

export default Layout;

<img src={require("file-loader!./images/cors3.jpg")} />

```notes
Server checks Origin header and adds ACAO header and if origin is allowed
Server add ACAC if cookies are allowed to be forwarded
```

---

export default Layout;

<img src={require("file-loader!./images/cors4.jpg")} />

```notes
Browser forwards the request
(Would block if no ACAO header)
(Would not send cookies if no ACAD header)
```

---

export default Layout;

Unfortunately..

- Access-Control-Allow-Origin: http://example.com
- Access-Control-Allow-Origin: \*
- Access-Control-Allow-Origin: null 🙅‍♂️

```notes
ACAO headers do not allow list, it is one origin, all origin, or null

Interestingly you think null means you dont trust any origin.

But null origins are resources that use file:// schemes
```

---

export default Layout;

Fortunately..

- Access-Control-Allow-Origin: \*
- Access-Control-Allow-Credentials: true

```notes
As someone who just wants to get this working

You might want to allow every origins and send cookies through

Fortunately, this will result in an error
```

---

export default Layout;

Misconfigured CORS example

- Reflect any origins in ACAO header
- Attacker could obtain sensitive info eg API keys

```notes
Developers might want to get around this * and true restriction by coding up the logic
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
app.use(
  cors({
    origin: (ctx) => 
      // reflecting whatever origin header is supplied 🔥
      return ctx.request.header.origin; 
    credentials: true,
  })
);
`}
/>

```notes
Our server here is going to add ACAO headers based on what Origin header was supplied

This is bad
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Attack: CORS reflecting any request origin header

http://vuln.hacker.com:2021/

http://127.0.0.1:9000/malicious-cors.html

```notes
3.1-cors.ts

The site currently only shows the balance of the logged in user
The site could should API keys
The server reflect origin as ACAO and forwards the page content
```

---

export default Layout;

<img src={require("file-loader!./images/surprisedpikachu4.jpg")} />

```notes
Dont worry pikachu this isnt too bad
```

---

export default Layout;

<img src={require("file-loader!./images/demogods2.png")} />

Defence: CORS only reflect ACAO on trusted sites

http://vuln.hacker.com:2021/

http://127.0.0.1:9000/malicious-cors.html

```notes
3.1.r1-cors-acao.ts

Show blocked by CORS error in browser
```

---

export default LayoutNoFooter;

<CodeSurfer
  theme={nightOwl}
  language="javascript"
  code={`
app.use(
  cors({
    origin: (ctx) => {
      const suppliedOrigin = ctx.request.header.origin;
      const trustedSites = ["https://shipit.com", "https://trustedsite.com"];
      if (trustedSites.includes(suppliedOrigin)) {
        return suppliedOrigin; // Only allow trusted sites✨
      }
      return false;
    },
    credentials: true,
  })
);
`}
/>

```notes
Our server only returns ACAO for trusted origins
```

---

export default Layout;

Confusing Origin: null

- Access-Control-Allow-Origin: null

```notes
Another confusing aspect of CORS is the null origin
When browser must send Origin header, it would be set to null
eg. iframe
```

---

export default Layout;

Defence against CORS misconfigurations

- Only allow trusted sites
  - Dynamically reflecting origins should be validated
- Avoid allowing ACAO: null

```notes

```

---

export default Layout;

## Summary

HTTP Cookie

Cross Site Scripting (XSS)

Cross Site Request Forgery (CSRF)

Cross-Origin Resource Sharing (CORS)

```notes
Good cookies headers like httpOnly, secure, and sameSite
XSS is scary, sanitise/validate your input
CSRF is performs action on behalf of users using cookies
CORS misconfiguration can lead to CSRF
```

---

export default Layout;

## Goodies

#### CS253: https://web.stanford.edu/class/cs253/

#### PortSwigger Web Security Academy: https://portswigger.net/web-security

#### Exploiting CORS Misconfigurations - James Kettle: https://youtu.be/wgkj4ZgxI4c

#### https://cheatsheetseries.owasp.org/cheatsheets/Cross-Site_Request_Forgery_Prevention_Cheat_Sheet.html

```notes
We are just scratching the surface!

If you are interested to a more deep dive here are some videos and labs
```

---

export default LayoutNoFooter;

<Lastpage></Lastpage>

# Thank You

```notes
Thanks for listening!
```
